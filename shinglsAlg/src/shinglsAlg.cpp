// shinglsAlg.cpp: определяет точку входа для консольного приложения.
//
#include "../headers/stdafx.h"
#include "../src/gsoap_autogenerated/shingle.nsmap"
#ifdef WIN32
    #include "../headers/targetver.h"
	unsigned _stdcall runService(void *);
#else
	void * runService(void *);
#endif
#include "../headers/ShingleApp.h"

const string exitCommand = "exit";
const string statCommand = "stat";
const string compactCommand = "compact";
const string resetDBcommand = "reset";

using namespace DePlaguarism;
using namespace std;

int http_get(struct soap *soap);


int main(int argc, char* argv[])
{
    THREAD_TYPE tid;
    setlocale(LC_ALL, "ru_RU.UTF-8");
    ShingleApp *srv = new ShingleApp();
    soap_set_imode(srv, SOAP_C_UTFSTRING);
    soap_set_omode(srv, SOAP_C_UTFSTRING);
	unsigned threadID;
    THREAD_CREATE(&tid, runService, (void*)srv, threadID);
    cout << "Application started!" << endl;
    string a;
    cin >> a;
    while (a != exitCommand){
        if (a == statCommand)
            srv->stat();
        if (a == compactCommand)
            srv->compactDB();
        if (a == resetDBcommand)
            srv->resetDB();
        cin >> a;
    }
    srv->stop();
    cout << "Application will be stopped then one more connection is accepted..." << endl;
    THREAD_JOIN(tid);
    delete srv;
    cin >> a;
    system("pause");
    return 0;
}

int http_get(struct soap *soap)
{
   FILE *fd = NULL;
   char *s = strchr(soap->path, '?');
   if (!s || strcmp(s, "?wsdl"))
      return SOAP_GET_METHOD;
   fd = fopen("shingle.wsdl", "rb"); // open WSDL file to copy
   if (!fd)
      return 404; // return HTTP not found error
   soap->http_content = "text/xml"; // HTTP header with text/xml content
   soap_response(soap, SOAP_FILE);
   for (;;)
   {
      size_t r = fread(soap->tmpbuf, 1, sizeof(soap->tmpbuf), fd);
      if (!r)
         break;
      if (soap_send_raw(soap, soap->tmpbuf, r))
         break; // can't send, but little we can do about that
   }
   fclose(fd);
   soap_end_send(soap);
   return SOAP_OK;
}


#ifdef WIN32
	unsigned _stdcall runService(void * app)
#else
	void * runService(void * app)
#endif
{
    ShingleApp * srv = (ShingleApp*)app;
    srv->fget = http_get;
    srv->log() << "Server putted up!\n" << srv->nowToStr() << '\n';
    srv->setMain();
    while (srv->run(SERVICE_PORT)){
        srv->log() << "Warning! Server is down \n" << "Server putted up!\n" << srv->nowToStr() << '\n';
    };
	return NULL;
}
